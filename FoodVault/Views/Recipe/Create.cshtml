@model FoodVault.Models.ViewModels.CreateRecipeViewModel
@{
    ViewData["Title"] = "Create Recipe";
}
<partial name="~/Views/Shared/_Messages.cshtml" />
<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="mb-3">
        <label asp-for="Title" class="form-label"></label>
        <input asp-for="Title" class="form-control" />
        <span asp-validation-for="Title" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Description" class="form-label"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
    </div>
    <div class="mb-3">
        <label class="form-label">Ảnh đại diện món ăn (nếu có)</label>
        <input type="file" name="Image" accept="image/*" class="form-control" />
    </div>
    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="Servings" class="form-label"></label>
            <input asp-for="Servings" class="form-control" />
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="PrepTimeMinutes" class="form-label"></label>
            <input asp-for="PrepTimeMinutes" class="form-control" />
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="CookTimeMinutes" class="form-label"></label>
            <input asp-for="CookTimeMinutes" class="form-control" />
        </div>
    </div>
    <h5 class="mt-4">Nguyên liệu</h5>
    <table class="table table-bordered w-auto">
        <thead><tr><th>Tên nguyên liệu</th><th>Số lượng</th><th>Đơn vị</th><th></th></tr></thead>
        <tbody id="ingredients-body">
        </tbody>
    </table>
    <div class="mb-3 d-flex gap-2">
        <input id="ingredient-name" class="form-control form-control-sm w-auto" placeholder="Tên nguyên liệu" />
        <input id="ingredient-qty" type="number" step="any" class="form-control form-control-sm w-auto" placeholder="Số lượng" />
        <input id="ingredient-unit" class="form-control form-control-sm w-auto" placeholder="Đơn vị" />
        <button type="button" class="btn btn-sm btn-primary" onclick="addIngredient()">Thêm nguyên liệu</button>
    </div>
    <input type="hidden" name="IngredientsJson" id="IngredientsJson" />
    <h5 class="mt-4">Các bước thực hiện</h5>
    <table class="table table-bordered w-auto">
        <thead><tr><th>Bước</th><th>Hướng dẫn</th><th></th></tr></thead>
        <tbody id="steps-body">
        </tbody>
    </table>
    <div class="mb-3 d-flex gap-2">
        <input id="step-number" type="number" min="1" class="form-control form-control-sm w-auto" placeholder="Số bước" />
        <input id="step-instruction" class="form-control form-control-sm w-auto" placeholder="Nội dung bước" />
        <button type="button" class="btn btn-sm btn-primary" onclick="addStep()">Thêm bước</button>
    </div>
    <input type="hidden" name="StepsJson" id="StepsJson" />

    <h5 class="mt-4">Tags (Thẻ phân loại)</h5>
    <div class="mb-3">
        <label class="form-label">Chọn tags cho công thức (có thể chọn nhiều)</label>
        
        <!-- Add new tag section -->
        <div class="mb-2 card p-2 bg-light">
            <div class="d-flex gap-2 align-items-end">
                <div class="flex-grow-1">
                    <label class="form-label small mb-1">Tạo tag mới:</label>
                    <input type="text" id="new-tag-name" class="form-control form-control-sm" placeholder="Nhập tên tag mới..." />
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-success" onclick="createNewTag()">
                        <i class="bi bi-plus-circle"></i> Thêm
                    </button>
                </div>
            </div>
            <div id="new-tag-error" class="text-danger small mt-1" style="display:none;"></div>
        </div>
        
        <!-- Search tags -->
        <div class="mb-2">
            <input type="text" id="tag-search" class="form-control form-control-sm" placeholder="Tìm kiếm tag..." style="max-width: 300px;" />
        </div>
        
        <!-- Tags list -->
        <div id="tags-container" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
            <div class="text-muted">Đang tải tags...</div>
        </div>
        
        <!-- Selected tags display -->
        <div id="selected-tags-container" class="mt-2">
            <small class="text-muted">Tags đã chọn: </small>
            <div id="selected-tags" class="d-flex flex-wrap gap-1 mt-1"></div>
        </div>
        <div id="tags-error" class="text-danger small mt-2" style="display:none;"></div>
    </div>
    <input type="hidden" name="TagsJson" id="TagsJson" />
    <button type="submit" class="btn btn-primary">Create</button>
    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let ingredients = [];
        let steps = [];
        // Tags functionality
        let selectedTags = [];
        let allTags = [];
        
        function updateSelectedTagsDisplay() {
            const container = document.getElementById('selected-tags');
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-muted">Chưa chọn tag nào</span>';
                return;
            }
            container.innerHTML = selectedTags.map(tag => 
                `<span class="badge bg-primary">${tag.name} <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick='removeTag("${tag.id}")' aria-label="Remove"></button></span>`
            ).join('');
            document.getElementById('TagsJson').value = JSON.stringify(selectedTags);
        }
        
        function removeTag(tagId) {
            const index = selectedTags.findIndex(t => t.id === tagId);
            if (index > -1) {
                selectedTags.splice(index, 1);
                updateSelectedTagsDisplay();
                // Uncheck the checkbox
                const checkbox = document.getElementById(`tag-${tagId}`);
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        }
        
        function redrawIngredients() {
            let tbody = document.getElementById('ingredients-body');
            tbody.innerHTML = ingredients.map((ing, idx) => `<tr><td>${ing.name}</td><td>${ing.qty}</td><td>${ing.unit}</td><td><button type='button' class='btn btn-sm btn-link text-danger' onclick='removeIngredient(${idx})'>X</button></td></tr>`).join('');
            document.getElementById('IngredientsJson').value = JSON.stringify(ingredients);
        }
        function addIngredient() {
            let name = document.getElementById('ingredient-name').value;
            let qty = document.getElementById('ingredient-qty').value;
            let unit = document.getElementById('ingredient-unit').value;
            if (!name || !qty) return;
            ingredients.push({ name: name, qty: qty, unit: unit });
            redrawIngredients();
            document.getElementById('ingredient-name').value = '';
            document.getElementById('ingredient-qty').value = '';
            document.getElementById('ingredient-unit').value = '';
        }
        function removeIngredient(idx) { ingredients.splice(idx, 1); redrawIngredients(); }
        function redrawSteps() {
            let tbody = document.getElementById('steps-body');
            tbody.innerHTML = steps.map((step, idx) => `<tr><td>${step.number}</td><td>${step.inst}</td><td><button type='button' class='btn btn-sm btn-link text-danger' onclick='removeStep(${idx})'>X</button></td></tr>`).join('');
            document.getElementById('StepsJson').value = JSON.stringify(steps);
        }
        function addStep() {
            let number = document.getElementById('step-number').value;
            let inst = document.getElementById('step-instruction').value;
            if (!number || !inst) return;
            steps.push({ number: number, inst: inst });
            redrawSteps();
            document.getElementById('step-number').value = '';
            document.getElementById('step-instruction').value = '';
        }
        function removeStep(idx) { steps.splice(idx, 1); redrawSteps(); }

        // Load available tags on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const container = document.getElementById('tags-container');
            const errorDiv = document.getElementById('tags-error');
            const searchInput = document.getElementById('tag-search');
            
            try {
                const response = await fetch('/api/tags/list');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tags = await response.json();
                
                if (!tags || tags.length === 0) {
                    container.innerHTML = '<div class="text-muted">Chưa có tags nào trong hệ thống.</div>';
                    return;
                }
                
                allTags = tags;
                renderTags(tags);
                
                // Search functionality
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filtered = allTags.filter(tag => 
                        tag.name.toLowerCase().includes(searchTerm)
                    );
                    renderTags(filtered);
                });
                
                errorDiv.style.display = 'none';
                updateSelectedTagsDisplay();
                
                // Setup Enter key for new tag input
                const newTagInput = document.getElementById('new-tag-name');
                if (newTagInput) {
                    newTagInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            createNewTag();
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading tags:', error);
                container.innerHTML = '<div class="text-danger">Không thể tải danh sách tags. Vui lòng thử lại sau.</div>';
                errorDiv.textContent = 'Lỗi: ' + error.message;
                errorDiv.style.display = 'block';
            }
        });

        function renderTags(tags) {
            const container = document.getElementById('tags-container');
            if (tags.length === 0) {
                container.innerHTML = '<div class="text-muted">Không tìm thấy tag nào.</div>';
                return;
            }
            
            container.innerHTML = '';
            tags.forEach((tag) => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.value = tag.id;
                checkbox.id = `tag-${tag.id}`;
                checkbox.setAttribute('data-tag-id', tag.id);
                checkbox.setAttribute('data-tag-name', tag.name);
                
                // Check if already selected
                if (selectedTags.find(t => t.id === tag.id)) {
                    checkbox.checked = true;
                }
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `tag-${tag.id}`;
                label.textContent = tag.name;
                label.style.cursor = 'pointer';
                
                checkbox.addEventListener('change', function() {
                    const tagId = this.getAttribute('data-tag-id');
                    const tagName = this.getAttribute('data-tag-name');
                    toggleTag(tagId, tagName);
                });
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        function toggleTag(tagId, tagName) {
            const index = selectedTags.findIndex(t => t.id === tagId);
            if (index > -1) {
                selectedTags.splice(index, 1);
            } else {
                selectedTags.push({ id: tagId, name: tagName });
            }
            updateSelectedTagsDisplay();
        }

        async function createNewTag() {
            const tagNameInput = document.getElementById('new-tag-name');
            const errorDiv = document.getElementById('new-tag-error');
            const tagName = tagNameInput.value.trim();
            
            if (!tagName) {
                errorDiv.textContent = 'Vui lòng nhập tên tag.';
                errorDiv.style.display = 'block';
                return;
            }
            
            errorDiv.style.display = 'none';
            tagNameInput.disabled = true;
            
            try {
                const response = await fetch('/api/tags/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: tagName })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Có lỗi xảy ra khi tạo tag.');
                }
                
                // Tag created successfully or already exists
                const newTag = { id: result.id, name: result.name };
                
                // Check if tag already in allTags
                const existingIndex = allTags.findIndex(t => t.id === newTag.id);
                if (existingIndex === -1) {
                    allTags.push(newTag);
                }
                
                // Add to selected tags if not already selected
                const selectedIndex = selectedTags.findIndex(t => t.id === newTag.id);
                if (selectedIndex === -1) {
                    selectedTags.push(newTag);
                }
                
                // Refresh tags display
                renderTags(allTags);
                updateSelectedTagsDisplay();
                
                // Clear input
                tagNameInput.value = '';
                tagNameInput.disabled = false;
                
                // Show success message briefly
                errorDiv.textContent = result.message || 'Tag đã được thêm thành công!';
                errorDiv.className = 'text-success small mt-1';
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Error creating tag:', error);
                errorDiv.textContent = error.message || 'Có lỗi xảy ra khi tạo tag.';
                errorDiv.className = 'text-danger small mt-1';
                errorDiv.style.display = 'block';
                tagNameInput.disabled = false;
            }
        }
    </script>
}










